<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI æ™ºèƒ½å…«å­—ç³»ç»Ÿ (V9.0 ç¡…åŸºç‰ˆ)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/lunar-javascript/lunar.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/zh.js"></script>

    <style>
        body { background-color: #f4f5f7; font-family: 'PingFang SC', sans-serif; }
        .pillar-card { 
            @apply bg-white border border-gray-200 rounded-lg p-3 flex flex-col items-center relative shadow-sm hover:shadow-md transition-shadow; 
            min-height: 290px; 
        }
        .pillar-head { @apply text-xs font-bold text-gray-500 mb-1 bg-gray-100 px-2 py-0.5 rounded; }
        .gan-zhi { @apply text-3xl font-extrabold text-gray-800 my-1; }
        .na-yin { @apply text-[10px] text-teal-600 border border-teal-100 px-1 rounded mb-2; }
        .hidden-stems { @apply w-full text-left text-xs text-gray-600 border-t border-dashed border-gray-200 pt-2 mt-1 space-y-1; }
        .life-stage { @apply absolute top-2 right-2 text-[10px] font-bold text-blue-600 bg-blue-50 px-1 rounded; }
        .kong-wang { @apply absolute top-2 left-2 text-[10px] text-gray-400 border border-gray-300 px-1 rounded; }
        .info-badge { @apply flex flex-col items-center bg-white p-2 rounded border text-xs; }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px; height: 36px; border-radius: 50%;
            border-left-color: #7c3aed;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="py-6 px-2 md:px-6">

<div class="max-w-5xl mx-auto">
    
    <div class="bg-white p-4 rounded-xl shadow-sm mb-5 border-l-4 border-purple-600 flex flex-col md:flex-row gap-4 justify-between items-center">
        <div>
            <h1 class="text-xl font-bold text-gray-800 flex items-center">
                ğŸ”® ä¹¾å¤ Â· AI å…«å­—
                <span class="ml-2 text-[10px] bg-purple-600 text-white px-2 py-0.5 rounded-full">V9.0 SiliconFlow</span>
            </h1>
            <p class="text-xs text-gray-500 mt-1">æ”¯æŒ Gemini & ç¡…åŸºæµåŠ¨ (DeepSeek/Qwen)</p>
        </div>
        <div class="w-full md:w-auto flex flex-col md:flex-row gap-2">
             <select id="modelSelect" onchange="updatePlaceholder()" class="p-2 border rounded text-xs bg-gray-50 font-bold text-gray-700 w-full md:w-48">
                <optgroup label="ç¡…åŸºæµåŠ¨ (SiliconFlow)">
                    <option value="deepseek-ai/DeepSeek-V3">DeepSeek V3 (æ¨è)</option>
                    <option value="deepseek-ai/DeepSeek-R1">DeepSeek R1 (æ·±åº¦æ¨ç†)</option>
                    <option value="Qwen/Qwen2.5-72B-Instruct">é€šä¹‰åƒé—® Qwen2.5</option>
                </optgroup>
                <optgroup label="Google Gemini">
                    <option value="gemini-2.5-flash">Gemini 2.5 Flash (æé€Ÿ)</option>
                </optgroup>
             </select>
             <input type="password" id="apiKey" class="p-2 border rounded text-xs w-full md:w-64" placeholder="è¾“å…¥ç¡…åŸºæµåŠ¨ Key (sk-...)">
        </div>
    </div>

    <div class="bg-white p-5 rounded-xl shadow-lg mb-6">
        <div class="grid grid-cols-2 md:grid-cols-6 gap-3">
            <div class="col-span-1"><label class="text-xs font-bold text-gray-500">å§“å</label><input type="text" id="name" class="w-full p-2 border rounded text-sm"></div>
            <div class="col-span-1"><label class="text-xs font-bold text-gray-500">æ€§åˆ«</label><select id="gender" class="w-full p-2 border rounded text-sm"><option value="1">ç”·</option><option value="0">å¥³</option></select></div>
            <div class="col-span-2"><label class="text-xs font-bold text-gray-500">å…¬å†æ—¥æœŸ</label><input type="text" id="birthDate" class="w-full p-2 border rounded text-sm bg-white" placeholder="é€‰æ‹©æ—¥æœŸ"></div>
            <div class="col-span-1"><label class="text-xs font-bold text-gray-500">æ—¶é—´</label><input type="time" id="birthTime" class="w-full p-2 border rounded text-sm" value="12:00"></div>
            <div class="col-span-1"><label class="text-xs font-bold text-gray-500">ç»åº¦(çœŸå¤ªé˜³)</label><input type="number" id="longitude" class="w-full p-2 border rounded text-sm" placeholder="120" value="120"></div>
        </div>
        <button onclick="calculate()" id="submitBtn" class="w-full mt-4 bg-purple-600 text-white font-bold py-3 rounded hover:bg-purple-700 transition shadow">
            ğŸŒŒ å¯åŠ¨ AI æ‰¹æ–­
        </button>
    </div>

    <div id="resultPanel" class="hidden animate-fade-in-up">
        
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
            <div class="pillar-card" id="yearCard"></div>
            <div class="pillar-card" id="monthCard"></div>
            <div class="pillar-card border-purple-400 ring-2 ring-purple-100" id="dayCard"></div>
            <div class="pillar-card" id="hourCard"></div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
            <div class="bg-white p-4 rounded-lg shadow-sm border col-span-1">
                <h3 class="text-xs font-bold text-gray-500 mb-2 border-b pb-1">å‘½å®« Â· èƒå…ƒ Â· äº”è¡Œ</h3>
                <div class="flex gap-2 mb-3">
                    <div class="info-badge flex-1">
                        <span class="text-gray-400 scale-75">èƒå…ƒ</span>
                        <strong class="text-lg text-gray-700" id="taiYuan">--</strong>
                    </div>
                    <div class="info-badge flex-1">
                        <span class="text-gray-400 scale-75">å‘½å®«</span>
                        <strong class="text-lg text-gray-700" id="mingGong">--</strong>
                    </div>
                </div>
                <div class="space-y-1" id="wuxingStats"></div>
            </div>

            <div class="bg-white p-4 rounded-lg shadow-sm border col-span-1 md:col-span-2">
                <h3 class="text-xs font-bold text-gray-500 mb-2 border-b pb-1 flex justify-between">
                    <span>åå¹´å¤§è¿</span>
                    <span id="startYunInfo" class="font-normal text-purple-600">--å²èµ·è¿</span>
                </h3>
                <div class="flex overflow-x-auto pb-2 gap-2" id="dayunList"></div>
            </div>
        </div>

        <div class="bg-white p-6 rounded-xl shadow-lg border-t-4 border-purple-600 min-h-[400px]">
            <div class="flex items-center gap-3 mb-6">
                <h3 class="text-xl font-bold text-purple-900">ğŸ¤– AI å¤§å¸ˆæ‰¹æ–­æŠ¥å‘Š</h3>
                <div id="aiStatus" class="text-xs text-gray-400">waiting...</div>
            </div>
            <div id="aiLoading" class="hidden flex flex-col items-center justify-center py-20">
                <div class="spinner mb-4"></div>
                <p class="text-gray-500 font-medium">æ­£åœ¨è¿æ¥æ¨¡å‹æ¨æ¼”å¤©æœº...</p>
                <p class="text-xs text-gray-400 mt-2" id="loadingText">æ·±åº¦æ€è€ƒä¸­ï¼Œè¯·è€å¿ƒç­‰å¾… 15-30 ç§’</p>
            </div>
            <div id="aiContent" class="prose prose-sm md:prose-base max-w-none hidden text-gray-700"></div>
            <div id="aiError" class="hidden bg-red-50 text-red-700 p-4 rounded border border-red-200"></div>
        </div>
    </div>
</div>

<script>
    flatpickr("#birthDate", { locale: "zh", defaultDate: "1990-01-01", allowInput: true });

    // åŠ¨æ€æ›´æ–° Placeholder
    function updatePlaceholder() {
        const model = document.getElementById('modelSelect').value;
        const input = document.getElementById('apiKey');
        if (model.includes('gemini')) {
            input.placeholder = "è¾“å…¥ Gemini Key (AIzaå¼€å¤´)";
        } else {
            input.placeholder = "è¾“å…¥ç¡…åŸºæµåŠ¨ Key (sk-å¼€å¤´)";
        }
    }
    // åˆå§‹åŒ–è°ƒç”¨ä¸€æ¬¡
    updatePlaceholder();

    // ==========================================
    // ğŸ›¡ï¸ æ ¸å¿ƒæ•°æ®å­—å…¸ (å†…ç½®ä¿éšœ)
    // ==========================================
    const ZHI_CANG_GAN = {
        'å­': ['ç™¸'], 'ä¸‘': ['å·±','ç™¸','è¾›'], 'å¯…': ['ç”²','ä¸™','æˆŠ'], 'å¯': ['ä¹™'],
        'è¾°': ['æˆŠ','ä¹™','ç™¸'], 'å·³': ['ä¸™','åºš','æˆŠ'], 'åˆ': ['ä¸','å·±'], 'æœª': ['å·±','ä¸','ä¹™'],
        'ç”³': ['åºš','å£¬','æˆŠ'], 'é…‰': ['è¾›'], 'æˆŒ': ['æˆŠ','è¾›','ä¸'], 'äº¥': ['å£¬','ç”²']
    };
    const WUXING_MAP = {
        'ç”²':'æœ¨', 'ä¹™':'æœ¨', 'ä¸™':'ç«', 'ä¸':'ç«', 'æˆŠ':'åœŸ', 'å·±':'åœŸ', 'åºš':'é‡‘', 'è¾›':'é‡‘', 'å£¬':'æ°´', 'ç™¸':'æ°´',
        'å­':'æ°´', 'ä¸‘':'åœŸ', 'å¯…':'æœ¨', 'å¯':'æœ¨', 'è¾°':'åœŸ', 'å·³':'ç«', 'åˆ':'ç«', 'æœª':'åœŸ', 'ç”³':'é‡‘', 'é…‰':'é‡‘', 'æˆŒ':'åœŸ', 'äº¥':'æ°´'
    };

    function calculateLifeStage(gan, zhi) {
        if(!gan || !zhi) return "";
        const stages = ["é•¿ç”Ÿ", "æ²æµ´", "å† å¸¦", "ä¸´å®˜", "å¸æ—º", "è¡°", "ç—…", "æ­»", "å¢“", "ç»", "èƒ", "å…»"];
        const zhis = ["å­", "ä¸‘", "å¯…", "å¯", "è¾°", "å·³", "åˆ", "æœª", "ç”³", "é…‰", "æˆŒ", "äº¥"];
        const map = {
            "ç”²": { start: "äº¥", forward: true }, "ä¹™": { start: "åˆ", forward: false },
            "ä¸™": { start: "å¯…", forward: true }, "ä¸": { start: "é…‰", forward: false },
            "æˆŠ": { start: "å¯…", forward: true }, "å·±": { start: "é…‰", forward: false },
            "åºš": { start: "å·³", forward: true }, "è¾›": { start: "å­", forward: false },
            "å£¬": { start: "ç”³", forward: true }, "ç™¸": { start: "å¯", forward: false }
        };
        const config = map[gan];
        if (!config) return "";
        const sIdx = zhis.indexOf(config.start);
        const tIdx = zhis.indexOf(zhi);
        let diff = config.forward ? (tIdx - sIdx + 12) % 12 : (sIdx - tIdx + 12) % 12;
        return stages[diff];
    }

    function toStr(obj) {
        try {
            if (typeof obj === 'string') return obj;
            if (obj && typeof obj.getName === 'function') return obj.getName();
            if (obj && typeof obj.toString === 'function') return obj.toString();
        } catch(e) { return ""; }
        return "";
    }

    async function calculate() {
        let apiKey = document.getElementById('apiKey').value.trim() || 'sk-msfvfnjqwkuvoipqpuedvvitadhjhdmjsycirrbhbncwtiaw';
        const model = document.getElementById('modelSelect').value;
        const name = document.getElementById('name').value;
        const gender = parseInt(document.getElementById('gender').value);
        const dateStr = document.getElementById('birthDate').value;
        const timeStr = document.getElementById('birthTime').value;
        const lng = parseFloat(document.getElementById('longitude').value) || 120.0;

        if(!apiKey) { alert("è¯·å¡«å…¥ API Key"); return; }
        if(!name || !dateStr) { alert("è¯·å¡«å†™å®Œæ•´ä¿¡æ¯"); return; }

        const btn = document.getElementById('submitBtn');
        btn.disabled = true; btn.innerHTML = "â³ æ­£åœ¨æ¼”ç®—ä¸­...";
        document.getElementById('resultPanel').classList.remove('hidden');
        document.getElementById('aiContent').classList.add('hidden');
        document.getElementById('aiLoading').classList.remove('hidden');
        document.getElementById('aiError').classList.add('hidden');
        
        // æ›´æ–°åŠ è½½æç¤º
        document.getElementById('aiStatus').innerText = `æ­£åœ¨è¿æ¥ ${model}...`;

        try {
            // 1. æ’ç›˜è®¡ç®—
            const [y, m, d] = dateStr.split('-').map(Number);
            const [hh, mm] = timeStr.split(':').map(Number);
            const offset = (lng - 120) * 4;
            let date = new Date(y, m - 1, d, hh, mm);
            date.setMinutes(date.getMinutes() + offset);

            const solar = Solar.fromYmdHms(date.getFullYear(), date.getMonth()+1, date.getDate(), date.getHours(), date.getMinutes(), 0);
            const lunar = solar.getLunar();
            const bazi = lunar.getEightChar();
            
            const yearGan = toStr(bazi.getYearGan()); const yearZhi = toStr(bazi.getYearZhi());
            const monthGan = toStr(bazi.getMonthGan()); const monthZhi = toStr(bazi.getMonthZhi());
            const dayGan = toStr(bazi.getDayGan()); const dayZhi = toStr(bazi.getDayZhi());
            const hourGan = toStr(bazi.getTimeGan()); const hourZhi = toStr(bazi.getTimeZhi());

            const dataMap = {
                year: { gan: yearGan, zhi: yearZhi, nayin: toStr(bazi.getYearNaYin()), xunkong: toStr(bazi.getYearXunKong()) },
                month: { gan: monthGan, zhi: monthZhi, nayin: toStr(bazi.getMonthNaYin()), xunkong: toStr(bazi.getMonthXunKong()) },
                day: { gan: dayGan, zhi: dayZhi, nayin: toStr(bazi.getDayNaYin()), xunkong: toStr(bazi.getDayXunKong()) },
                hour: { gan: hourGan, zhi: hourZhi, nayin: toStr(bazi.getTimeNaYin()), xunkong: toStr(bazi.getTimeXunKong()) }
            };

            const renderPillar = (title, d, isDay=false) => {
                const changsheng = calculateLifeStage(dayGan, d.zhi);
                const hiddenArr = ZHI_CANG_GAN[d.zhi] || [];
                let hiddenHTML = '';
                hiddenArr.forEach(g => { hiddenHTML += `<div>${g}</div>`; });

                return {
                    html: `
                        <div class="pillar-head">${title}</div>
                        <div class="kong-wang">${d.xunkong}</div>
                        <div class="life-stage">${changsheng}</div>
                        <div class="gan-zhi ${isDay?'text-purple-700':''}">${d.gan}${d.zhi}</div>
                        <div class="na-yin">${d.nayin}</div>
                        <div class="hidden-stems">
                            <div class="flex gap-2 text-[10px] text-gray-500 justify-center">${hiddenHTML}</div>
                        </div>
                    `,
                    dataStr: `${d.gan}${d.zhi}`
                };
            };

            const yearHTML = renderPillar("å¹´æŸ±", dataMap.year);
            const monthHTML = renderPillar("æœˆæŸ±", dataMap.month);
            const dayHTML = renderPillar("æ—¥æŸ± (å…ƒç¥)", dataMap.day, true);
            const hourHTML = renderPillar("æ—¶æŸ±", dataMap.hour);

            document.getElementById('yearCard').innerHTML = yearHTML.html;
            document.getElementById('monthCard').innerHTML = monthHTML.html;
            document.getElementById('dayCard').innerHTML = dayHTML.html;
            document.getElementById('hourCard').innerHTML = hourHTML.html;

            let mingGong = "--", taiYuan = "--";
            try { mingGong = toStr(bazi.getMingGong()); taiYuan = toStr(bazi.getTaiYuan()); } catch(e){}
            document.getElementById('mingGong').innerText = mingGong;
            document.getElementById('taiYuan').innerText = taiYuan;

            const allChars = [yearGan, yearZhi, monthGan, monthZhi, dayGan, dayZhi, hourGan, hourZhi];
            const wuxingCount = { 'é‡‘':0, 'æœ¨':0, 'æ°´':0, 'ç«':0, 'åœŸ':0 };
            allChars.forEach(c => {
                const wx = WUXING_MAP[c];
                if(wx) wuxingCount[wx]++;
            });
            let wuxingHTML = '';
            for(let [k,v] of Object.entries(wuxingCount)) {
                wuxingHTML += `<div class="flex justify-between text-xs text-gray-600"><span>${k}</span><span class="font-bold">${v}</span></div>
                <div class="w-full bg-gray-100 h-1.5 rounded-full overflow-hidden mb-1"><div class="h-full bg-purple-500" style="width:${v*12.5}%"></div></div>`;
            }
            document.getElementById('wuxingStats').innerHTML = wuxingHTML;

            let dayunHTML = '';
            let currentDaYunStr = "æœªèµ·è¿";
            let futureDaYunStr = [];
            
            try {
                const yun = bazi.getYun(gender);
                const daYunArr = yun.getDaYun(); 
                let startAge = 1;
                if(daYunArr.length > 1) {
                    try { startAge = daYunArr[1].getStartAge(); } catch(e) { startAge = 1; }
                }
                document.getElementById('startYunInfo').innerText = `${startAge}å²èµ·è¿`;

                const currentYear = new Date().getFullYear();
                const birthYear = date.getFullYear();

                for (let i = 1; i < Math.min(daYunArr.length, 9); i++) {
                    const dy = daYunArr[i];
                    const gz = toStr(dy.getGanZhi());
                    let daYunStartAge = 0;
                    let daYunEndAge = 0;
                    try { daYunStartAge = dy.getStartAge(); daYunEndAge = dy.getEndAge(); } 
                    catch(e) { daYunStartAge = i*10; daYunEndAge = (i+1)*10 - 1; }
                    
                    const startY = birthYear + daYunStartAge;
                    const endY = birthYear + daYunEndAge;
                    
                    const isCurrent = (currentYear >= startY && currentYear <= endY);
                    if(isCurrent) currentDaYunStr = `${gz}è¿ (${startY}å¹´-${endY}å¹´)`;
                    futureDaYunStr.push(`${gz}(${daYunStartAge}-${daYunEndAge}å²)`);

                    dayunHTML += `
                        <div class="flex-shrink-0 w-20 p-2 rounded border text-center ${isCurrent?'bg-purple-600 text-white shadow-md transform scale-105':'bg-gray-50 text-gray-600'}">
                            <div class="font-bold">${gz}</div>
                            <div class="text-[10px] scale-90">${daYunStartAge}å²èµ·</div>
                        </div>
                    `;
                }
            } catch(e) { dayunHTML = '<div class="p-2 text-xs text-gray-400">å¤§è¿è®¡ç®—å¼‚å¸¸</div>'; }
            document.getElementById('dayunList').innerHTML = dayunHTML;

            let future12Years = [];
            let startForecastYear = new Date().getFullYear();
            try {
                for(let i=0; i<12; i++) {
                    const fy = startForecastYear + i;
                    const tempSolar = Solar.fromYmd(fy, 6, 15); 
                    const tempLunar = tempSolar.getLunar();
                    const yearGZ = toStr(tempLunar.getYearInGanZhi());
                    future12Years.push(`${fy}å¹´(${yearGZ})`);
                }
            } catch(e) { future12Years.push("æµå¹´æ•°æ®åŠ è½½å¤±è´¥"); }

            // ===========================================
            // ğŸ¤– AI è¯·æ±‚é€»è¾‘ (ç¡…åŸºæµåŠ¨é€‚é…)
            // ===========================================
            const prompt = `
ä½ æ˜¯ä¸€ä½ç²¾é€šã€Šä¸‰å‘½é€šä¼šã€‹ã€ã€Šæ¸Šæµ·å­å¹³ã€‹çš„èµ„æ·±å‘½ç†å¤§å¸ˆã€‚è¯·æ ¹æ®ä»¥ä¸‹**å…¨ç»´æ•°æ®**è¿›è¡Œç»ˆææ‰¹æ–­ã€‚

ã€åŸºç¡€æ¡£æ¡ˆã€‘
- å§“åï¼š${name} (${gender==1?'ç”·':'å¥³'})
- å…«å­—ï¼š${yearHTML.dataStr} ${monthHTML.dataStr} ${dayHTML.dataStr} ${hourHTML.dataStr}
- çº³éŸ³ï¼š${dataMap.year.nayin} / ${dataMap.month.nayin} / ${dataMap.day.nayin} / ${dataMap.hour.nayin}
- ç©ºäº¡ï¼šå¹´[${dataMap.year.xunkong}] æœˆ[${dataMap.month.xunkong}] æ—¥[${dataMap.day.xunkong}] æ—¶[${dataMap.hour.xunkong}]
- å‘½å®«ï¼š${mingGong} | èƒå…ƒï¼š${taiYuan}
- äº”è¡Œç»Ÿè®¡ï¼šé‡‘${wuxingCount['é‡‘']} æœ¨${wuxingCount['æœ¨']} æ°´${wuxingCount['æ°´']} ç«${wuxingCount['ç«']} åœŸ${wuxingCount['åœŸ']}

ã€è¿ç¨‹æ•°æ®ã€‘
- å½“å‰å¤§è¿ï¼š**${currentDaYunStr}**
- å¤§è¿åºåˆ—ï¼š${futureDaYunStr.join(' -> ')}
- æœªæ¥12å¹´æµå¹´åºåˆ—ï¼š${future12Years.join(', ')}

ã€æ·±åº¦åˆ†æè¦æ±‚ (Markdownæ ¼å¼)ã€‘
è¯·æ’°å†™ä¸€ä»½ç»“æ„ä¸¥è°¨ã€é€»è¾‘ç¼œå¯†ã€ä¸æå°å»ºè¿·ä¿¡ä½†ä¿ç•™ä¸“ä¸šæœ¯è¯­çš„åˆ†ææŠ¥å‘Šã€‚

### 1. ğŸŒŸ å‘½å±€æ€»æˆ
* **æ—¥å…ƒèƒ½é‡**ï¼šç»“åˆæœˆä»¤åŠäº”è¡Œä¸ªæ•°ï¼Œåˆ¤æ–­èº«å¼ºèº«å¼±ã€‚
* **æ ¼å±€åˆ†æ**ï¼šåˆ¤æ–­æ ¼å±€é«˜ä½ï¼Œç»“åˆâ€œç©ºäº¡â€åˆ†æã€‚
* **ç¥ç…ç‚¹ç›**ï¼šæ¨æ–­å…³é”®ç¥ç…ï¼ˆå¦‚å¤©ä¹™è´µäººã€æ¡ƒèŠ±ã€ç¾Šåˆƒï¼‰ï¼Œç®€è¿°å½±å“ã€‚

### 2. â˜¯ï¸ å‘½å®«ä¸èƒå…ƒ
* ç®€æå‘½å®«ä¸èƒå…ƒå¯¹å‘½å±€çš„è¡¥å……ä½œç”¨ã€‚

### 3. ğŸ’¼ äº‹ä¸šè´¢è¿
* åˆ†æè´¢æ˜Ÿä¸å®˜æ€ã€‚å¦‚æœè´¢æ˜Ÿåâ€œé•¿ç”Ÿ/å¸æ—ºâ€å¦‚ä½•ï¼Ÿå¦‚æœè½â€œç©ºäº¡â€æœ‰ä½•é£é™©ï¼Ÿ
* ç»™å‡ºè¡Œä¸šå»ºè®®ä¸æ±‚è´¢æ–¹ä½ã€‚

### 4. ğŸ”® æœªæ¥12å¹´æµå¹´å‰å‡¶è¯¦æ‰¹ (è¡¨æ ¼å½¢å¼)
è¯·ä»¥è¡¨æ ¼å½¢å¼é¢„æµ‹ **${startForecastYear}å¹´è‡³${startForecastYear+11}å¹´** çš„è¿åŠ¿ã€‚
* **è¡¨æ ¼åˆ—å**ï¼šå¹´ä»½ | å¹²æ”¯ | è¯„åˆ†(1-5æ˜Ÿ) | æ ¸å¿ƒå…³é”®è¯ | ç®€è¯„ (ç»“åˆæµå¹´å¹²æ”¯ä¸æ—¥ä¸»åç¥å…³ç³»)ã€‚

### 5. ğŸ“œ å¤§å¸ˆé€ å‘½ç®´è¨€
* é’ˆå¯¹å‘½å±€æœ€è–„å¼±ç¯èŠ‚ï¼Œç»™å‡ºå…·ä½“çš„ä¿®èº«å»ºè®®ã€‚
`;

            let aiResponseText = "";

            if (model.includes("gemini")) {
                // --- Gemini æ¥å£ ---
                const url = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`;
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });
                const json = await response.json();
                if (!response.ok) throw new Error(json.error?.message || "Gemini è¯·æ±‚å¤±è´¥");
                aiResponseText = json.candidates[0].content.parts[0].text;

            } else {
                // --- ç¡…åŸºæµåŠ¨ (SiliconFlow) æ¥å£ ---
                // ç¡…åŸºæµåŠ¨çš„ API åœ°å€é€šå¸¸æ˜¯ https://api.siliconflow.cn/v1/chat/completions
                // å…¼å®¹ OpenAI æ ¼å¼
                const url = "https://api.siliconflow.cn/v1/chat/completions";
                
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}` // ç¡…åŸºæµåŠ¨éœ€è¦ Bearer Token
                    },
                    body: JSON.stringify({
                        model: model, // ä¾‹å¦‚ deepseek-ai/DeepSeek-V3
                        messages: [
                            {"role": "system", "content": "ä½ æ˜¯ä¸€ä½ä¸“ä¸šçš„å…«å­—å‘½ç†å¤§å¸ˆã€‚"},
                            {"role": "user", "content": prompt}
                        ],
                        stream: false
                    })
                });
                
                if (!response.ok) {
                    const errJson = await response.json();
                    throw new Error(errJson.error?.message || `ç¡…åŸºæµåŠ¨è¯·æ±‚å¤±è´¥: ${response.status}`);
                }
                
                const json = await response.json();
                aiResponseText = json.choices[0].message.content;
            }

            document.getElementById('aiContent').innerHTML = marked.parse(aiResponseText);
            document.getElementById('aiContent').classList.remove('hidden');

        } catch (e) {
            document.getElementById('aiError').innerText = "å‘ç”Ÿé”™è¯¯ï¼š" + e.message;
            document.getElementById('aiError').classList.remove('hidden');
        } finally {
            btn.disabled = false; btn.innerHTML = "ğŸŒŒ å¯åŠ¨ AI æ‰¹æ–­";
            document.getElementById('aiLoading').classList.add('hidden');
            document.getElementById('resultPanel').scrollIntoView({ behavior: 'smooth' });
        }
    }
</script>
</body>
</html>
