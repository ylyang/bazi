<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gemini æ™ºèƒ½å…«å­—æ’ç›˜ (ç¨³å®šè¿æ¥ç‰ˆ)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/lunar-javascript/lunar.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        .pillar-box { @apply bg-teal-50 p-4 rounded-lg border border-teal-100 text-center; }
        .gan-zhi-text { @apply text-2xl font-bold text-gray-800 my-2; }
    </style>
</head>
<body class="bg-slate-50 min-h-screen py-10 px-4">

<div class="max-w-3xl mx-auto">
    
    <div class="bg-white p-6 rounded-xl shadow-sm mb-6 border-l-4 border-teal-500">
        <h3 class="text-lg font-bold mb-4 flex items-center text-teal-700">
            ğŸ”§ API è¿æ¥è®¾ç½®
        </h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
                <label class="block text-sm font-bold mb-2">Gemini API Key</label>
                <input type="password" id="apiKey" class="w-full p-2 border rounded focus:outline-none focus:border-teal-500" placeholder="ç²˜è´´ä»¥ AIzaSy å¼€å¤´çš„å¯†é’¥">
                <div class="mt-2 text-xs text-gray-500">
                    <a href="https://aistudio.google.com/app/apikey" target="_blank" class="text-teal-600 hover:underline">ğŸ‘‰ ç‚¹æ­¤è·å– Key</a>
                </div>
            </div>
            <div>
                <label class="block text-sm font-bold mb-2">é€‰æ‹© AI æ¨¡å‹</label>
                <select id="modelSelect" class="w-full p-2 border rounded focus:outline-none focus:border-teal-500">
                    <option value="gemini-2.5-flash">Gemini 2.5 Flash (æ¨è)</option>
                </select>
            </div>
        </div>
    </div>

    <div class="bg-white p-8 rounded-xl shadow-lg mb-8">
        <h2 class="text-3xl font-extrabold text-center text-teal-800 mb-8">ğŸ”® Gemini å…«å­—æ’ç›˜</h2>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div><label class="block text-sm font-bold mb-2">å§“å</label><input type="text" id="name" class="w-full p-3 border rounded-lg"></div>
            <div><label class="block text-sm font-bold mb-2">æ€§åˆ«</label><select id="gender" class="w-full p-3 border rounded-lg"><option value="1">ç”·</option><option value="0">å¥³</option></select></div>
            <div><label class="block text-sm font-bold mb-2">å‡ºç”Ÿæ—¥æœŸ</label><input type="date" id="birthDate" class="w-full p-3 border rounded-lg"></div>
            <div><label class="block text-sm font-bold mb-2">å‡ºç”Ÿæ—¶é—´</label><input type="time" id="birthTime" class="w-full p-3 border rounded-lg" value="12:00"></div>
            <div class="md:col-span-2">
                <label class="block text-sm font-bold mb-2">ç»åº¦ (çœŸå¤ªé˜³æ—¶)</label>
                <input type="number" id="longitude" step="0.0001" class="w-full p-3 border rounded-lg" placeholder="ä¾‹å¦‚åŒ—äº¬: 116.4">
            </div>
        </div>

        <button onclick="startCalculation()" id="submitBtn" class="w-full mt-8 bg-teal-600 text-white font-bold py-4 rounded-lg text-lg hover:bg-teal-700 transition-all shadow-md">
            ğŸš€ å¼€å§‹æµ‹ç®—
        </button>
    </div>

    <div id="resultArea" class="hidden">
        <div class="bg-white p-8 rounded-xl shadow-lg mb-8">
            <div class="grid grid-cols-4 gap-4 mb-6">
                <div class="pillar-box"><div class="text-xs text-gray-500">å¹´æŸ±</div><div class="gan-zhi-text" id="yearPillar">--</div></div>
                <div class="pillar-box"><div class="text-xs text-gray-500">æœˆæŸ±</div><div class="gan-zhi-text" id="monthPillar">--</div></div>
                <div class="pillar-box bg-teal-100 border-teal-300"><div class="text-xs text-gray-500">æ—¥æŸ±(ä½ )</div><div class="gan-zhi-text" id="dayPillar">--</div></div>
                <div class="pillar-box"><div class="text-xs text-gray-500">æ—¶æŸ±</div><div class="gan-zhi-text" id="hourPillar">--</div></div>
            </div>
        </div>

        <div class="bg-white p-8 rounded-xl shadow-lg border-t-4 border-teal-500">
            <div id="aiLoading" class="hidden text-center py-10">
                <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-teal-600 mx-auto mb-4"></div>
                <p class="text-gray-600">æ­£åœ¨è¯·æ±‚ Google Gemini...</p>
            </div>
            <div id="aiContent" class="prose prose-teal max-w-none hidden"></div>
            <div id="aiError" class="hidden bg-red-100 text-red-800 p-4 rounded-lg"></div>
        </div>
    </div>
</div>

<script>
    async function startCalculation() {
        // 1. è·å–å¹¶æ¸…ç† Key (å…³é”®ä¿®å¤ï¼šå»é™¤ç©ºæ ¼)
        let apiKey = document.getElementById('apiKey').value || 'AIzaSyA_cQ53Daamd0kef3bAZKSQ1glKTjieUR8';
        if(apiKey) apiKey = apiKey.trim(); 

        const name = document.getElementById('name').value;
        const dateStr = document.getElementById('birthDate').value;
        const timeStr = document.getElementById('birthTime').value;
        let longitude = parseFloat(document.getElementById('longitude').value) || 120.0;
        const selectedModel = document.getElementById('modelSelect').value;

        // éªŒè¯ Key
        if (!apiKey) {
            alert("âš ï¸ é”™è¯¯ï¼šAPI Key ä¸ºç©ºï¼\nè¯·åœ¨æœ€ä¸Šæ–¹çš„è¾“å…¥æ¡†ä¸­ç²˜è´´æ‚¨çš„ Google Gemini API Keyã€‚");
            document.getElementById('apiKey').focus();
            return;
        }

        if (!name || !dateStr || !timeStr) {
            alert("è¯·å¡«å†™å®Œæ•´çš„å‡ºç”Ÿä¿¡æ¯");
            return;
        }

        // UI çŠ¶æ€æ›´æ–°
        const btn = document.getElementById('submitBtn');
        btn.disabled = true;
        btn.innerHTML = 'â³ æ­£åœ¨è¿æ¥ Google...';
        document.getElementById('resultArea').classList.remove('hidden');
        document.getElementById('aiContent').classList.add('hidden');
        document.getElementById('aiError').classList.add('hidden');
        document.getElementById('aiLoading').classList.remove('hidden');

        try {
            // --- è®¡ç®—é€»è¾‘ ---
            const [y, m, d] = dateStr.split('-').map(Number);
            const [hh, mm] = timeStr.split(':').map(Number);
            const timeOffset = (longitude - 120) * 4;
            let date = new Date(y, m - 1, d, hh, mm);
            date.setMinutes(date.getMinutes() + timeOffset);

            const solar = Solar.fromYmdHms(date.getFullYear(), date.getMonth()+1, date.getDate(), date.getHours(), date.getMinutes(), 0);
            const lunar = solar.getLunar();
            const bazi = lunar.getEightChar();
            
            // æ˜¾ç¤ºæ’ç›˜
            document.getElementById('yearPillar').innerText = bazi.getYear();
            document.getElementById('monthPillar').innerText = bazi.getMonth();
            document.getElementById('dayPillar').innerText = bazi.getDay();
            document.getElementById('hourPillar').innerText = bazi.getTime();

            // --- AI è¯·æ±‚é€»è¾‘ (ä¿®å¤ç‰ˆ) ---
            const baziInfo = `å§“å:${name}, æ€§åˆ«:${document.getElementById('gender').value==1?'ç”·':'å¥³'}, å…«å­—:${bazi.getYear()} ${bazi.getMonth()} ${bazi.getDay()} ${bazi.getTime()}`;
            
            const prompt = `ä½ æ˜¯ä¸€ä½ä¸“ä¸šçš„å…«å­—å‘½ç†å¸ˆã€‚è¯·æ ¹æ®æ­¤ä¿¡æ¯è¿›è¡Œæ·±åº¦æ€§æ ¼å’Œè¿åŠ¿åˆ†æ(Markdownæ ¼å¼ï¼Œä¸åŒ…å«è¿·ä¿¡æå“)ï¼š${baziInfo}`;
            
            // æ„é€ è¯·æ±‚ URL (ç¡®ä¿ key åœ¨ URL ä¸­)
            const url = `https://generativelanguage.googleapis.com/v1beta/models/${selectedModel}:generateContent?key=${apiKey}`;
            
            // å‘é€è¯·æ±‚
            const response = await fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    // é¢å¤–å°è¯•åœ¨ Header ä¸­ä¹Ÿæ”¾å…¥ Keyï¼Œå¢åŠ æˆåŠŸç‡
                    'x-goog-api-key': apiKey 
                },
                body: JSON.stringify({
                    contents: [{ parts: [{ text: prompt }] }]
                })
            });

            if (!response.ok) {
                const errJson = await response.json();
                throw new Error(errJson.error?.message || response.statusText);
            }

            const data = await response.json();
            const text = data.candidates[0].content.parts[0].text;
            
            document.getElementById('aiContent').innerHTML = marked.parse(text);
            document.getElementById('aiContent').classList.remove('hidden');

        } catch (e) {
            document.getElementById('aiError').innerHTML = `<strong>è¯·æ±‚å¤±è´¥ï¼š</strong> ${e.message}<br><br>æ£€æŸ¥å»ºè®®ï¼š<br>1. ç¡®ä¿ Key æ²¡æœ‰å¤åˆ¶å¤šä½™çš„ç©ºæ ¼ã€‚<br>2. ç¡®ä¿ Key æ˜¯ä» AI Studio è·å–çš„ (AIzaSyå¼€å¤´)ã€‚`;
            document.getElementById('aiError').classList.remove('hidden');
        } finally {
            document.getElementById('aiLoading').classList.add('hidden');
            btn.disabled = false;
            btn.innerHTML = 'ğŸš€ é‡æ–°æµ‹ç®—';
            document.getElementById('resultArea').scrollIntoView({ behavior: 'smooth' });
        }
    }
</script>
</body>
</html>